---
title: "6.prelim_viz"
author: "abbey yatsko"
date: "26/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(plyr)
library(ggpubr)
library(viridis)
library(tidyr)
library(broom)
library(purrr)
library(tidyverse)
library(rstatix)
library(easystats)
library(ggeffects)
library(lme4)
library(lmerTest)
```

read in data 
```{r data load}
may_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_may22_fixed.csv")
may_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_may22_fixed.csv")

nov_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_nov22_fixed.csv")
nov_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_nov22_fixed.csv")

aug_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_aug23_fixed.csv")
aug_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_aug23_fixed.csv")

aug_day_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_aug23_day_fixed.csv")
aug_day_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_aug23_day_fixed")
```

data clean and reorganize
```{r}
# lists of CO2 and CH4 files from different seasons
CH4_all <- list(may_CH4, nov_CH4, aug_CH4)
CO2_all <- list(may_CO2, nov_CO2, aug_CO2)

# create new column for methane:co2
# for each element in list 
x <- data.frame(CO2_all[1])
y <- data.frame(CH4_all[1])

full_df <- function(x, y){
  # merge CO2 and CH4 df together 
  all <- full_join(x, y)

  # convert CO2 from mmol to umol (in order to match CH4 units, conversion factor 1000umol = 1mmol)
  all$flux.CO2_umol <- all$flux.CO2*1000
  all <- all %>% relocate(flux.CO2_umol, .after = flux.CO2)
  all <- all %>% relocate(flux.CH4, .after = flux.CO2_umol)
  all <- all %>% relocate(R2.CH4, .after = R2.CO2)
  all <- all %>% relocate(p.CH4, .after = p.CO2)
  
  # define column for ratio of CH4:CO2
  all$CH4_CO2 <-  all$flux.CH4/all$flux.CO2_umol
  all <- all %>% relocate(CH4_CO2, .after = flux.CH4)

}

out <- lapply(seq_along(CH4_all), function(x) full_df(CH4_all[[x]], CO2_all[[x]]))
all_fluxes <- do.call("rbind.fill", out)

# rename species with scientific names 
all_fluxes$species_s <- ifelse(all_fluxes$species == "Ami", "A. laurensis","")
all_fluxes$species_s <- ifelse(all_fluxes$species == "Nasuti", "N. magnus", all_fluxes$species_s)
all_fluxes$species_s <- ifelse(all_fluxes$species == "Copto", "C. acinaciformis", all_fluxes$species_s)

# write.csv(all_fluxes, "/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes.csv")

# fluxes for repeatedly measured termite mounds: filter out those that are not revisited by the resampling campaigns 
targets1 <- unique(nov_CH4$sample)
targets2 <- unique(aug_CH4$sample)
targets <- union(targets1, targets2)

all_fluxes_resample <- all_fluxes[all_fluxes$sample %in% targets, ]

# omit soil measurements cause they're not needed right now
all_fluxes_resample <- all_fluxes_resample[all_fluxes_resample$flux_source =="m",]
all_fluxes_resample$tag <- as.factor(all_fluxes_resample$tag)

# create unique ID for mounds in different sampling periods
all_fluxes_resample$ID_mound <- paste(all_fluxes_resample$sample, all_fluxes_resample$campaign, sep = "-")

# how many measurements were made for each mound in the resampling campaign (shoudl be 4 or 5)
repeated_counts <- aggregate(all_fluxes_resample$tag , by=list(all_fluxes_resample$ID_mound ), FUN=length)

# reorder levels of campaigns 
all_fluxes_resample$campaign <- factor(all_fluxes_resample$campaign, levels = c("may22", "aug23", "nov22"))

# create working df for coarse mound averages 
detach(package:plyr)
mound_avg_flux <- all_fluxes_resample %>% group_by(ID_mound, sample, species_s) %>% 
  summarise(mean_mound_fluxCH4=mean(flux.CH4),
            mean_mound_fluxCO2=mean(flux.CO2_umol), 
            mean_mound_fluxCH4_CO2=mean(CH4_CO2), 
            campaign = campaign)
```

Intramound variation - look at mound-level CoV 
```{r}
# calculate CoV for each mound
detach(package:plyr)
cov <- all_fluxes_resample %>% group_by(ID_mound) %>% 
  summarize(cov = sd(flux.CH4) / mean(flux.CH4))
ggplot(cov, aes(cov)) +
  geom_histogram(aes(y=after_stat(density)), colour="black", fill="white")+
 geom_density(alpha=.2, fill="#FF6666") +
  theme_classic()

x <- cov[cov$cov > 1, ] # 14/75 mounds have high CoV - test these further
names <- x$ID_mound
test <- all_fluxes_resample[all_fluxes_resample$ID_mound %in% names,]

# one-way anova - using measurement tags (4-5 per mound)
ggboxplot(test, x = "tag", y = "flux.CH4",
          color = "tag", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#FC4E40", "#FC9E40"),
          ylab = "Flux", xlab = "Position")
aov1 <- aov(flux.CH4 ~ tag, data = test)
summary(aov1)

# one-way anova - using position (Mid/low/top)
ggboxplot(test, x = "position", y = "flux.CH4",
          color = "position", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          ylab = "Flux", xlab = "Position")
aov2 <- aov(flux.CH4 ~ position, data = test)
summary(aov2)

# one-way anova - using direction (NESW)
ggboxplot(test, x = "directon", y = "flux.CH4",
          color = "directon", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#FC4E40", "#FC9E40"),
          ylab = "Flux", xlab = "Position")
aov3 <- aov(flux.CH4 ~ directon, data = test)
summary(aov3)

# intramound variation is not significant - calculate overall mound average and use this in further analyses
```

Testing models randomly and with some difficulty
```{r}

# model with subsample position within individual mound measurement as a random effect
# CH4
model <- lmer(flux.CH4 ~ species_s + campaign + avg_respT + (1|tag), data=all_fluxes_resample, REML=TRUE)
anova(model)
rand(model)
check_model(model)
ggpredict(model, terms = c("avg_respT", "species_s", "campaign")) %>% plot(add.data = TRUE)

# CO2
model <- lmer(flux.CO2 ~ species_s + campaign + avg_respT + (1|tag), data=all_fluxes_resample, REML=TRUE)
anova(model)
rand(model)
check_model(model)
ggpredict(model, terms = c("avg_respT", "species_s", "campaign")) %>% plot(add.data = TRUE)

# from notes 
# model 1: intramound flux variation 
# flux ~ species + temp + wallthickness + time (season/ToD)

# model 2: mound level flux 
# flux ~ species + temp  + season + ToD + size

# model 3: landscape level flux
# flux ~ species + mounddensity + size + season
```

Q1: mound flux by species
```{r flux}
# overall CH4 flux from three different species
s1 <- ggplot(data = all_fluxes_resample[all_fluxes_resample$flux_source =="m",], aes(x = species_s, y = flux.CH4, fill = species_s)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")+ 
  theme(legend.position = "none")

# overall CO2 flux from three different species
s2 <- ggplot(data = all_fluxes_resample[all_fluxes_resample$flux_source =="m",], aes(x = species_s, y = flux.CO2, fill = species_s)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylab("CO2 flux mmol/d/m2")+
  xlab("")+ 
  theme(legend.position = "none")

# overall CH4:CO2 from three different species
s3 <- ggplot(data = all_fluxes_resample[all_fluxes_resample$flux_source =="m",], aes(x = species_s, y = CH4_CO2, fill = species_s)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylab("CH4:CO2")+
  ylim(0,0.075)+ # removes big outlier
  xlab("")+ 
  theme(legend.position = "none")

ggarrange(s1,s2,s3, ncol = 3)

# model to test 
mod <- lm(flux.CH4 ~ species_s, data = all_fluxes_resample)
summary(mod)

# table of averages (by species, season)
detach(package:plyr)
sp_avg <- all_fluxes_resample %>% group_by(species_s) %>% 
  summarize(mean_CH4flux = mean(flux.CH4), 
            mean_CO2flux = mean(flux.CO2), 
            sd_CH4flux = sd(flux.CH4), 
            sd_CO2flux = sd(flux.CO2))

season_avg <- all_fluxes_resample %>% group_by(species_s, campaign) %>% 
  summarize(mean_CH4flux = mean(flux.CH4), 
            mean_CO2flux = mean(flux.CO2), 
            sd_CH4flux = sd(flux.CH4), 
            sd_CO2flux = sd(flux.CO2))
  
# unit conversion umol/m2*d to ug/m2*d (final units for CH4)
# flux*(1/1000000)*(16.04)*(1000000) 
# molecular mass conversion to g, then conversion back to ug for comparison 
```

Q2: mound flux by mound size
```{r}
# merge with mound SA
mound_SA <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/moundSA.csv")
mound_SA <- mound_SA[, c('sample', 'SA_m2', 'basal_area_m2')]
mound_SA <- mound_SA[!is.na(mound_SA$SA_m2),]
mound_avg_flux <- merge(mound_avg_flux, mound_SA, by = "sample" )

# calculate mound-level flux
mound_avg_flux$mound_CH4flux <- mound_avg_flux$mean_mound_fluxCH4 * mound_avg_flux$SA_m2
mound_avg_flux$mound_CO2flux <- mound_avg_flux$mean_mound_fluxCO2 * mound_avg_flux$SA_m2

# graph methane flux by mound size (surface/basal area interchangeable: SA_m2/basal_area_m2)
a1 <- ggplot(data = mound_avg_flux, aes(x = SA_m2, y = mean_mound_fluxCH4)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  #facet_grid(~campaign, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CH4 flux (umol/d/mound)") +
  xlab("Mound basal area (m2)")

# graph carbon dioxide flux by mound size 
a2 <- ggplot(data = mound_avg_flux, aes(x = basal_area_m2, y = mean_mound_fluxCO2)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(campaign~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CO2 flux (mmol/d/mound)") +
  xlab("Mound basal area (m2)")

# graph CH4:CO2 flux by mound size 
a3 <- ggplot(data = mound_avg_flux, aes(x = basal_area_m2, y = mean_mound_fluxCH4_CO2)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CH4:CO2") +
  xlab("Mound basal area (m2)")

ggarrange(a1, a2, a3, ncol = 1)

# relationship between surface area and basal area (by species)
ggplot(data = mound_avg_flux, aes(x = SA_m2, y = basal_area_m2)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Mound basal area (m2)") +
  xlab("Mound surface area (m2)")

# preliminary models 
mod <- lm(mean_mound_fluxCH4 ~ SA_m2 + species_s, data = mound_avg_flux)
summary(mod)
check_model(mod)
ggpredict(mod, terms = c("SA_m2", "species_s")) %>% plot(add.data = TRUE)

```

Q3. drivers of flux variation throughout the day
{see 5.DAILY_process.Rmd}

Q4. gas flux change across seasons 
```{r by species}
# overall CH4 flux by campaign
ggplot(data = all_fluxes_resample, aes(x = campaign, y = flux.CH4, fill = species_s)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")

# compare campaigns directly for different species
a <- ggplot(data = all_fluxes_resample, aes(x = species_s, y = flux.CH4, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")
b <- ggplot(data = all_fluxes_resample, aes(x = species_s, y = flux.CO2, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylab("CO2 flux mmol/d/m2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")
c <- ggplot(data = all_fluxes_resample, aes(x = species_s, y = CH4_CO2, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,0.07)+
  ylab("CH4:CO2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")

ggarrange(a, b, c, common.legend = TRUE, ncol = 1)
```

Q5. relationship between mound gas flux and temperature
```{r}
# mound flux and temperature
t1 <- ggplot(all_fluxes_resample, aes(x = avg_respT, y = flux.CH4))+
  geom_point()+
  facet_wrap(~species_s)+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CH4 flux umol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  ylim(0,26000)+
  theme_classic()

t2 <- ggplot(all_fluxes_resample, aes(x = avg_respT, y = flux.CO2))+
  geom_point()+
  facet_wrap(~species_s)+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CO2 flux mmol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  ylim(0,5000)+
  theme_classic()

ggarrange(t1, t2, ncol = 1)

# mound flux and time of day with temperature included
t <- all_fluxes_resample[all_fluxes_resample$campaign %in% c("nov22", "aug23"),]
t$flux_start <- strptime(t$flux_start, "%H:%M")
tt <- all_fluxes_resample[all_fluxes_resample$campaign %in% c("may22"),]
time_all_fluxes <- rbind(t, tt)

t3 <- ggplot(time_all_fluxes, aes(x = as.POSIXct(flux_start), y = flux.CH4, color = avg_respT))+
  geom_point()+
  facet_wrap(~campaign, scales = "free_x")+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CH4 flux umol/d/m2")+
  xlab("Time of day")+
  scale_color_viridis(option="magma")+
  theme_classic()+
  ylim(0,30000) 

t4 <- ggplot(time_all_fluxes, aes(x = as.POSIXct(flux_start), y = flux.CO2, color = avg_respT))+
  geom_point()+
  facet_wrap(~campaign, scales = "free_x")+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CO2 flux mmol/d/m2")+
  xlab("Time of day")+
  scale_color_viridis(option="magma")+
  theme_classic()
  #ylim(0,30000) 
ggarrange(t3, t4, ncol = 1, common.legend = TRUE)

# temperature throughout the day
ggplot(time_all_fluxes, aes(x = as.POSIXct(flux_start), y = avg_respT, color = avg_respT))+
  geom_point()+
  facet_wrap(~campaign, scales = "free_x")+
  ylab("Average Mound Surface Temperature (C)")+
  xlab("Time of day")+
  scale_color_viridis(option="magma")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))

# preliminary models
# does temp change throughout the day? 
mod <- lm(avg_respT ~ as.POSIXct(flux_start), data = time_all_fluxes)
summary(mod)

mod1 <- lm(flux.CO2 ~ as.POSIXct(flux_start) + species_s + campaign, data = time_all_fluxes)
summary(mod1)

mod2 <- lm(flux.CH4 ~ as.POSIXct(flux_start) + species_s + campaign, data = time_all_fluxes)
summary(mod2)

mod3 <- lm(flux.CO2 ~ avg_respT + species_s + campaign, data = time_all_fluxes)
summary(mod3)
ggpredict(mod3, terms = c("avg_respT", "species_s", "campaign")) %>% plot(add.data = TRUE)

mod4 <- lm(flux.CH4 ~ avg_respT + species_s + campaign, data = time_all_fluxes)
summary(mod4)
ggpredict(mod4, terms = c("avg_respT", "species_s", "campaign")) %>% plot(add.data = TRUE)
```

