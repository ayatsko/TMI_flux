---
title: "6.prelim_viz"
author: "abbey yatsko"
date: "26/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(plyr)
library(ggpubr)
library(viridis)
library(tidyr)
library(broom)
library(purrr)
library(tidyverse)
library(rstatix)
```

read in data 
```{r data load}
may_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_may22_fixed.csv")
may_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_may22_fixed.csv")

nov_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_nov22_fixed.csv")
nov_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_nov22_fixed.csv")

aug_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_aug23_fixed.csv")
aug_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_aug23_fixed.csv")

aug_day_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_aug23_day_fixed.csv")
aug_day_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_aug23_day_fixed")
```

data clean and reorganize
```{r}
# lists of CO2 and CH4 files from different seasons
CH4_all <- list(may_CH4, nov_CH4, aug_CH4)
CO2_all <- list(may_CO2, nov_CO2, aug_CO2)

# create new column for methane:co2
# for each element in list 
x <- data.frame(CO2_all[1])
y <- data.frame(CH4_all[1])

full_df <- function(x, y){
  # merge CO2 and CH4 df together 
  all <- full_join(x, y)

  # convert CO2 from mmol to umol (in order to match CH4 units, conversion factor 1000umol = 1mmol)
  all$flux.CO2_umol <- all$flux.CO2*1000
  all <- all %>% relocate(flux.CO2_umol, .after = flux.CO2)
  all <- all %>% relocate(flux.CH4, .after = flux.CO2_umol)
  all <- all %>% relocate(R2.CH4, .after = R2.CO2)
  all <- all %>% relocate(p.CH4, .after = p.CO2)
  
  # define column for ratio of CH4:CO2
  all$CH4_CO2 <-  all$flux.CH4/all$flux.CO2_umol
  all <- all %>% relocate(CH4_CO2, .after = flux.CH4)

}

out <- lapply(seq_along(CH4_all), function(x) full_df(CH4_all[[x]], CO2_all[[x]]))
all_fluxes <- do.call("rbind.fill", out)

# rename species with scientific names 
all_fluxes$species_s <- ifelse(all_fluxes$species == "Ami", "A. laurensis","")
all_fluxes$species_s <- ifelse(all_fluxes$species == "Nasuti", "N. magnus", all_fluxes$species_s)
all_fluxes$species_s <- ifelse(all_fluxes$species == "Copto", "C. acinaciformis", all_fluxes$species_s)

# write.csv(all_fluxes, "/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes.csv")
```

mound flux by species
```{r flux}
# overall CH4 flux from three different species
ggplot(data = all_fluxes, aes(x = species_s, y = flux.CH4, fill = flux_source)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")

# overall CO2 flux from three different species
ggplot(data = all_fluxes, aes(x = species_s, y = flux.CO2, fill = flux_source)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  #ylim(0,26000)+ # removes big outlier
  ylab("CO2 flux mmol/d/m2")+
  xlab("")

# overall CH4:CO2 from three different species
ggplot(data = all_fluxes, aes(x = species_s, y = CH4_CO2, fill = flux_source)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylab("CH4:CO2")+
  ylim(0,0.1)+ # removes big outlier
  xlab("")

# table of averages (by species, season)
detach(package:plyr)
sp_avg <- all_fluxes %>% group_by(species_s) %>% 
  summarize(mean_CH4flux = mean(flux.CH4), 
            mean_CO2flux = mean(flux.CO2), 
            sd_CH4flux = sd(flux.CH4), 
            sd_CO2flux = sd(flux.CO2))

season_avg <- all_fluxes %>% group_by(species_s, campaign) %>% 
  summarize(mean_CH4flux = mean(flux.CH4), 
            mean_CO2flux = mean(flux.CO2), 
            sd_CH4flux = sd(flux.CH4), 
            sd_CO2flux = sd(flux.CO2))
  
# unit conversion umol/m2*d to ug/m2*d (final units for CH4)
# flux*(1/1000000)*(16.04)*(1000000) 
# molecular mass conversion to g, then conversion back to ug for comparison 
```

mound and soil methane flux by position, direction
```{r by position}
# mounds 
ggplot(data = all_fluxes[all_fluxes$flux_source == "m",], aes(x = species_s, y = flux.CH4, fill = position))+ 
  geom_boxplot()+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  ylab("CH4 flux umol/d/m2")+
  xlab("Position")+
  theme_classic()

ggplot(data = all_fluxes[all_fluxes$flux_source == "m",], aes(x = species_s, y = flux.CH4, fill = directon))+ 
  geom_boxplot()+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  ylab("CH4 flux umol/d/m2")+
  xlab("Position")+
  theme_classic()

# soils 
ggplot(data = all_fluxes[all_fluxes$flux_source == "s",], aes(x = species_s, y = flux.CH4, fill = position)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  ylab("CH4 flux umol/d/m2")+
  xlab("Position")+
  theme_classic()
```

mound flux by time of year
```{r by species}
# reorder levels of campaigns 
all_fluxes$campaign <- factor(all_fluxes$campaign, levels = c("may22", "aug23", "nov22"))

# overall CH4 flux by campaign
sp_all_fluxes <- all_fluxes[all_fluxes$species %in% c("Nasuti", "Ami", "Copto"),]
ggplot(data = sp_all_fluxes, aes(x = campaign, y = flux.CH4, fill = species_s)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")

# compare campaigns directly for different species
a <- ggplot(data = all_fluxes, aes(x = species_s, y = flux.CH4, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")+
  facet_wrap(~species_s, scales = "free")

b <- ggplot(data = all_fluxes, aes(x = species_s, y = flux.CO2, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylab("CO2 flux mmol/d/m2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")

c <- ggplot(data = all_fluxes, aes(x = species_s, y = CH4_CO2, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,0.07)+
  ylab("CH4:CO2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")

ggarrange(a, b, c, common.legend = TRUE, ncol = 1)

f2 <- ggplot(data = all_fluxes[all_fluxes$species_s == "A. laurensis",], aes(x = species_s, y = flux.CH4, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0, 8000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  scale_x_discrete(limits = c("A. laurensis"))+
  xlab("")

ggarrange(f1, f2, f3, f4, f5, f6, f7, f8, f9, common.legend = TRUE)
```

relationship between mound flux and temperature, time of day
```{r}
# mound flux and temperature
t1 <- ggplot(sp_all_fluxes, aes(x = avg_respT, y = flux.CH4))+
  geom_point()+
  facet_wrap(~species_s)+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CH4 flux umol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  ylim(0,26000)+
  theme_classic()

t2 <- ggplot(sp_all_fluxes, aes(x = avg_respT, y = flux.CO2))+
  geom_point()+
  facet_wrap(~species_s)+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CO2 flux mmol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  ylim(0,5000)+
  theme_classic()

ggarrange(t1, t2, ncol = 1)

# mound flux and time of day 
t <- sp_all_fluxes[sp_all_fluxes$campaign %in% c("nov22", "aug23"),]
t$flux_start <- strptime(t$flux_start, "%H:%M")
tt <- sp_all_fluxes[sp_all_fluxes$campaign %in% c("may22"),]
time_all_fluxes <- rbind(t, tt)

t3 <- ggplot(time_all_fluxes, aes(x = as.POSIXct(flux_start), y = flux.CH4, color = avg_respT))+
  geom_point()+
  facet_wrap(~campaign, scales = "free_x")+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CH4 flux umol/d/m2")+
  xlab("Time of day")+
  scale_color_viridis(option="magma")+
  theme_classic()+
  ylim(0,30000) 

t4 <- ggplot(time_all_fluxes, aes(x = as.POSIXct(flux_start), y = flux.CO2, color = avg_respT))+
  geom_point()+
  facet_wrap(~campaign, scales = "free_x")+
  geom_smooth(method = 'lm', se = FALSE, color = "red")+
  ylab("CO2 flux mmol/d/m2")+
  xlab("Time of day")+
  scale_color_viridis(option="magma")+
  theme_classic()
  #ylim(0,30000) 
ggarrange(t3, t4, ncol = 1, common.legend = TRUE)

# temperature throughout the day
ggplot(time_all_fluxes, aes(x = as.POSIXct(flux_start), y = avg_respT, color = avg_respT))+
  geom_point()+
  facet_wrap(~campaign, scales = "free_x")+
  ylab("Average Mound Surface Temperature (C)")+
  xlab("Time of day")+
  scale_color_viridis(option="magma")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))
```

entire mound-level flux incorporating mound SA from photogrammetry
```{r}
# find average flux by mound 
sp_all_fluxes$ID_measurement <- paste(sp_all_fluxes$sample, sp_all_fluxes$campaign, sep = "-")

mound_avg_flux <- sp_all_fluxes %>% group_by(ID_measurement, sample, species_s) %>% 
  summarise(mean_mound_fluxCH4=mean(flux.CH4),mean_mound_fluxCO2=mean(flux.CO2_umol), mean_mound_fluxCH4_CO2=mean(CH4_CO2))

# merge with mound SA
mound_SA <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/moundSA.csv")
mound_SA <- mound_SA[, c('sample', 'SA_m2', 'basal_area_m2')]
mound_SA <- mound_SA[!is.na(mound_SA$SA_m2),]
mound_avg_flux <- merge(mound_avg_flux, mound_SA, by = "sample" )

# calculate mound-level flux
mound_avg_flux$mound_CH4flux <- mound_avg_flux$mean_mound_fluxCH4 * mound_avg_flux$SA_m2
mound_avg_flux$mound_CO2flux <- mound_avg_flux$mean_mound_fluxCO2 * mound_avg_flux$SA_m2

# graph methane flux by mound size (surface/basal area interchangeable: SA_m2/basal_area_m2)
a1 <- ggplot(data = mound_avg_flux, aes(x = basal_area_m2, y = mean_mound_fluxCH4)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CH4 flux (umol/d/mound)") +
  xlab("Mound basal area (m2)")

# graph carbon dioxide flux by mound size 
a2 <- ggplot(data = mound_avg_flux, aes(x = basal_area_m2, y = mean_mound_fluxCO2)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CO2 flux (mmol/d/mound)") +
  xlab("Mound basal area (m2)")

# graph CH4:CO2 flux by mound size 
a3 <- ggplot(data = mound_avg_flux, aes(x = basal_area_m2, y = mean_mound_fluxCH4_CO2)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CH4:CO2") +
  xlab("Mound basal area (m2)")

ggarrange(a1, a2, a3, ncol = 1)

# relationship between surface area and basal area (by species)
ggplot(data = mound_avg_flux, aes(x = SA_m2, y = basal_area_m2)) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species_s, scales = "free_x")+ 
  theme_classic()+
  ylab("Mound basal area (m2)") +
  xlab("Mound surface area (m2)")
```

