---
title: "6.prelim_viz"
author: "abbey yatsko"
date: "26/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(ggpubr)
library(viridis)
library(tidyr)
library(broom)
library(purrr)
library(tidyverse)
library(rstatix)
```

read in data 
```{r data load}
may_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_may22_fixed.csv")
may_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_may22_fixed.csv")

nov_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_nov22_fixed.csv")
nov_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_nov22_fixed.csv")

aug_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_aug23_fixed.csv")
aug_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_aug23_fixed.csv")

aug_day_CO2 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinal_aug23_day_fixed.csv")
aug_day_CH4 <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinal_aug23_day_fixed")
```

data clean and reorganize
```{r}
# lists of CO2 and CH4 files from different seasons
CH4_all <- list(may_CH4, nov_CH4, aug_CH4)
CO2_all <- list(may_CO2, nov_CO2, aug_CO2)

# create new column for methane:co2
# for each element in list 
x <- data.frame(CO2_all[1])
y <- data.frame(CH4_all[1])

full_df <- function(x, y){
  # merge CO2 and CH4 df together 
  all <- full_join(x, y)

  # convert CO2 from mmol to umol (in order to match CH4 units, conversion factor 1000umol = 1mmol)
  all$flux.CO2_umol <- all$flux.CO2*1000
  all <- all %>% relocate(flux.CO2_umol, .after = flux.CO2)
  all <- all %>% relocate(flux.CH4, .after = flux.CO2_umol)
  all <- all %>% relocate(R2.CH4, .after = R2.CO2)
  all <- all %>% relocate(p.CH4, .after = p.CO2)
  
  # define column for ratio of CH4:CO2
  all$CH4_CO2 <-  all$flux.CH4/all$flux.CO2_umol
  all <- all %>% relocate(CH4_CO2, .after = flux.CH4)

}

out <- lapply(seq_along(CH4_all), function(x) full_df(CH4_all[[x]], CO2_all[[x]]))
all_fluxes <- do.call("rbind.fill", out)

# rename species with scientific names 
all_fluxes$species_s <- ifelse(all_fluxes$species == "Ami", "A. laurensis","")
all_fluxes$species_s <- ifelse(all_fluxes$species == "Nasuti", "N. magnus", all_fluxes$species_s)
all_fluxes$species_s <- ifelse(all_fluxes$species == "Copto", "C. acinaciformis", all_fluxes$species_s)

# write.csv(all_fluxes, "/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes.csv")
```

mound flux by species
```{r flux}
# overall CH4 flux from three different species
ggplot(data = all_fluxes, aes(x = species_s, y = flux.CH4, fill = flux_source)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")

# overall CO2 flux from three different species
ggplot(data = all_fluxes, aes(x = species_s, y = flux.CO2, fill = flux_source)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  #ylim(0,26000)+ # removes big outlier
  ylab("CO2 flux mmol/d/m2")+
  xlab("")

# overall CH4:CO2 from three different species
ggplot(data = all_fluxes, aes(x = species_s, y = CH4_CO2, fill = flux_source)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylab("CH4:CO2")+
  ylim(0,0.1)+ # removes big outlier
  xlab("")
```

mound and soil methane flux by position, direction
```{r by position}
# mounds 
ggplot(data = all_fluxes[all_fluxes$flux_source == "m",], aes(x = species_s, y = flux.CH4, fill = position))+ 
  geom_boxplot()+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  ylab("CH4 flux umol/d/m2")+
  xlab("Position")+
  theme_classic()

ggplot(data = all_fluxes[all_fluxes$flux_source == "m",], aes(x = species_s, y = flux.CH4, fill = directon))+ 
  geom_boxplot()+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  ylab("CH4 flux umol/d/m2")+
  xlab("Position")+
  theme_classic()

# soils 
ggplot(data = all_fluxes[all_fluxes$flux_source == "s",], aes(x = species_s, y = flux.CH4, fill = position)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  ylab("CH4 flux umol/d/m2")+
  xlab("Position")+
  theme_classic()
```

mound flux by time of year
```{r by species}
# reorder levels of campaigns 
all_fluxes$campaign <- factor(all_fluxes$campaign, levels = c("may22", "aug23", "nov22"))

# overall CH4 flux by campaign
sp_all_fluxes <- all_fluxes[all_fluxes$species %in% c("Nasuti", "Ami", "Copto"),]
ggplot(data = sp_all_fluxes, aes(x = campaign, y = flux.CH4, fill = species_s)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")

# compare campaigns directly for different species
ggplot(data = all_fluxes, aes(x = species_s, y = flux.CH4, fill = campaign)) + 
  geom_boxplot()+
  theme_classic()+
  ylim(0,26000)+ # removes big outlier
  ylab("CH4 flux umol/d/m2")+
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+
  xlab("")
```

relationship between mound flux and temperature, time of day
```{r}
# temperature
ggplot(sp_all_fluxes, aes(x = avg_respT, y = flux.CH4))+
  geom_point()+
  geom_smooth(method = 'lm', se = FALSE)+
  ylab("CH4 flux umol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  theme_classic()

# time of day 
everyother <- function(x) x[seq_along(x) %% 5 == 0]
ggplot(sp_all_fluxes, aes(x = flux_start, y = flux.CH4))+
  geom_point()+
  facet_wrap(~campaign, scales = "free")+
  ylab("CH4 flux umol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  scale_x_discrete(breaks = everyother)

#TODO need to fix aug x axis - out of order 
```


##########################################
############## DRAFT #####################
##########################################

scaled mound flux from calculated SA
```{r}
# find average flux by mound, calculating seperately remeasured mounds  
# group by mound_campaign
y1 <- mounds_ID %>% group_by(mound_campaign) %>% 
  summarise(mean_fluxCH4=mean(flux.CH4),mean_fluxCO2=mean(flux.CO2_umol), mean_fluxCH4CO2=mean(ch4_co2) )
y1 <- separate(y1, col=mound_campaign, into=c('sample', 'campaign'), sep='-')

# merge with mound_SA
mound_SA <- read.csv("/Users/abbeyyatsko/Downloads/mound SA - Sheet1 (1).csv")
mound_SA <- mound_SA[, c('sample', 'working_sa_m2')]
mound_SA <- mound_SA[!is.na(mound_SA$working_sa_m2),]
z <- merge(y1, mound_SA, by = "sample" )
z$totalCH4flux <- z$mean_fluxCH4 * z$working_sa_m2
z$totalCO2flux <- z$mean_fluxCO2 * z$working_sa_m2
z <- merge(z, species, by = "sample" )

# graph mound flux by mound size (use scaled flux - this is the actual flux being represented by the true size of the mound)
# methane
z$species <- ifelse(z$ID_cleaned == "Ami", "A. laurensis", "")
z$species <- ifelse(z$ID_cleaned == "Nasuti", "N. magnus",z$species )
z$species <- ifelse(z$ID_cleaned == "Copto", "C. acinaciformis", z$species)
ggplot(data = z[!z$ID_cleaned == "Macro",], aes(x = working_sa_m2, y = log(totalCH4flux))) +
  stat_poly_line() +
  stat_poly_eq(use_label(c("adj.R2", "f", "p"))) +
  geom_point()+ 
  geom_smooth(method = 'lm')+
  scale_color_brewer("Blues")+
  facet_wrap(~species, ncol = 1)+ # scales = "free_x"
  theme_classic()+
  ylab("Total mound CH4 flux (log scale, umol/d/mound)") +
  xlab("Mound surface area (m2)")

summary(lm(log(totalCH4flux) ~  working_sa_m2, data = z[z$ID_cleaned == "Nasuti",]))

# carbon dioxide
ggplot(data =  z[z$ID_cleaned == "Ami",], aes(x = working_sa_m2, y = totalCO2flux, color = campaign)) + 
  geom_point()+ 
  geom_smooth(method = 'lm')+
  facet_wrap(~ID_cleaned, scales = "free_x")+ 
  theme_classic()+
  ylab("Total mound CO2 flux umol/d/mound") +
  xlab("mound surface area")

# methane:carbon dioxide
ggplot(data = z[z$ID_cleaned == "Nasuti",], aes(x = working_sa_m2, y = mean_fluxCH4CO2, color = campaign)) + 
  geom_point()+ 
  geom_smooth(method = 'lm')+
  facet_wrap(~ID_cleaned, scales = "free_x")+
  theme_classic()+
  ylab("Total mound CH4:CO2") +
  xlab("mound surface area")
```

calculate average flux per species 
```{r}
# average fluxes - may 
# remove NAs 
maymounds_ID <- maymounds[!is.na(maymounds$ID_cleaned),]

may_avg <- maymounds_ID %>% group_by(ID_cleaned) %>% 
  summarise(mean_flux=mean(flux.CH4),
            .groups = 'drop')

# average fluxes - nov 
nov_avg <- novmounds %>% group_by(ID_cleaned) %>% 
  summarise(mean_flux=mean(flux.CH4),
            .groups = 'drop')

# to convert umol/m2*d to ug/m2*d:
# avgflux_ami <- avgflux_ami*(1/1000000)*(16.04)*(1000000) # molecular mass conversion to g, then conversion back to ug for comparison 
# avgflux_nasute <- avgflux_nasute*(1/1000000)*(16.04)*(1000000) 
# avgflux_copto <- avgflux_copto*(1/1000000)*(16.04)*(1000000) 
# final units for average fluxes are now in ug CH4/m2*d
```

