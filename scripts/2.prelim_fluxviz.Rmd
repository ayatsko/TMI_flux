---
title: "2.prelim_fluxviz"
author: "abbey yatsko"
date: "26/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(ggpubr)
```

## read in data 
```{r data load}
CO2_fluxfinal <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CO2_fluxfinalTMI.csv")
CH4_fluxfinal<- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/CH4_fluxfinalTMI.csv")
```

## merge in species data to flux data 
```{r}
species <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/Abbey termites .xlsx - Sheet1.csv")
species <- species[c("X", "ID_cleaned")]

# merge sp and CH4flux_final, CO2_fluxfinal
species <- species %>%
  rename(sample = X)
CH4_fluxfinal <- merge(CH4_fluxfinal, species, by = c("sample")) 
CO2_fluxfinal <- merge(CO2_fluxfinal, species, by = c("sample")) 

# new column for methane:co2
# first need to convert CO2 from mmol to umol (in order to match CH4 in units of umol)
# (conversion factor 1000umol = 1mmol)
CO2_fluxfinal$flux.CO2_umol <- CO2_fluxfinal$flux.CO2*1000
CO2_fluxfinal <- CO2_fluxfinal %>% relocate(flux.CO2_umol, .after = flux.CO2)

CH4_fluxfinal$ch4_co2 <-  CH4_fluxfinal$flux.CH4/CO2_fluxfinal$flux.CO2
CH4_fluxfinal <- CH4_fluxfinal %>% relocate(ch4_co2, .after = flux.CH4)

# subset df to create just soils and just mounds (for later on. just to have df prepped)
soils <- CH4_fluxfinal[CH4_fluxfinal$flux_source == 's',]
mounds <- CH4_fluxfinal[CH4_fluxfinal$flux_source == 'm',]
```

## methane flux by individual mound
```{r flux}
# mounds all, colored by species
a1 <- ggplot(data = mounds, aes(x = as.factor(sample), y = flux.CH4, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  geom_jitter()+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("CH4 flux umol/d/m2")+
  labs(title = "mound")

# soils all, colored by species
a2 <- ggplot(data = soils, aes(x = as.factor(sample), y = flux.CH4, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  geom_jitter()+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylab("CH4 flux umol/d/m2")+
  labs(title = "soil")
ggarrange(a1, a2, ncol=1)

# same as above but with CH4:CO2
a3 <- ggplot(data = mounds, aes(x = as.factor(sample), y = ch4_co2, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylim(0,50)+ # for outliers
  labs(title = "mound")
a4 <- ggplot(data = soils, aes(x = as.factor(sample), y = ch4_co2, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  theme_classic()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+
  ylim(0,2.5)+ # for outliers
  labs(title = "soil")
ggarrange(a3, a4, ncol=1)
```

## methane flux by mound or soil measurement 
```{r by soil/mound}
b <- ggplot(data = CH4_fluxfinal, aes(x = as.factor(flux_source), y = flux.CH4)) + 
  geom_boxplot()+ 
  geom_jitter()+
  theme_light()
```

## methane flux by factor(position)
```{r by position}
c1 <- ggplot(data = CH4_fluxfinal, aes(x = as.factor(position), y = flux.CH4, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  ylab("CH4 flux umol/d/m2")+
  theme_light()
c2 <- ggplot(data = CH4_fluxfinal, aes(x = as.factor(position), y = ch4_co2, fill = ID_cleaned)) + 
  geom_boxplot()+
  ylim(0,50)+ # for outliers
  theme_light()

ggarrange(c1, c2, ncol = 1)
```

## methane flux for mounds only by factor(direction)
```{r by direction}
d1 <- ggplot(data = mounds, aes(x = as.factor(directon), y = flux.CH4, fill = flux_source)) + 
  geom_boxplot()+ 
  geom_jitter()+
  ylab("CH4 flux umol/d/m2")+
  theme_light()
d2 <- ggplot(data = mounds, aes(x = as.factor(directon), y = ch4_co2, fill = flux_source)) + 
  geom_boxplot()+ 
  geom_jitter()+
  theme_light()

ggarrange(d1, d2, ncol = 1)
```

## methane flux by factor(species)
```{r by species}
e <- ggplot(data = CH4_fluxfinal, aes(x = as.factor(ID_cleaned), y = flux.CH4, fill = flux_source)) + 
  geom_boxplot()+ 
  ylab("CH4 flux umol/d/m2")+
  theme_light()
```

## methane flux by methane:co2 
```{r}
 f <- ggplot(data = CH4_fluxfinal, aes(x = as.factor(ID_cleaned), y = ch4_co2, fill = flux_source)) + 
  geom_boxplot()+ 
  geom_jitter()+
  theme_light()+
  scale_y_continuous(limits = c(-1, 50))

ggarrange(e, f, ncol = 1)
```

## methane flux by species faceted with mound/soil and positioning
```{r}
g <- ggplot(data = CH4_fluxfinal, aes(x = as.factor(ID_cleaned), y = flux.CH4, fill = flux_source)) + 
  geom_boxplot()+ 
  geom_point(aes(col=position), position = "jitter")+
  ylab("CH4 flux umol/d/m2")+
  theme_light()
```

# methane flux by mound average for different parts of the day 
```{r}
# merge in real time data from GPS records of mound being tagged (this is an overall mound estimate)
time <- read.csv("/Users/abbeyyatsko/Downloads/mound_gps (1).csv")
time <- time[c("name", "realtime")]
names(time)[1] <- 'sample'
CH4_fluxfinal <- merge(CH4_fluxfinal, time, by = c("sample")) 
CH4_fluxfinal <- CH4_fluxfinal %>% relocate(realtime, .after = Time_start)

mounds <- CH4_fluxfinal[CH4_fluxfinal$flux_source == 'm',]
soils <- CH4_fluxfinal[CH4_fluxfinal$flux_source == 's',]

# scatter plot for flux by time of day (for mounds)
g1 <- ggplot(data = mounds, aes(x = as.factor(realtime), y = flux.CH4, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  ylab("CH4 flux umol/d/m2")+
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_light()
# scatter plot for flux by time of day (for soils)
g2 <- ggplot(data = soils, aes(x = as.factor(realtime), y = flux.CH4, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  ylab("CH4 flux umol/d/m2")+
  scale_x_discrete(guide = guide_axis(angle = 90)) +
  theme_light()
ggarrange(g1, g2, ncol = 1)

#### TODAY #####
# using radial graph for mounds
g3 <- ggplot(data = moundsCO2, aes(x = as.factor(realtime), y = flux.CH4, fill = ID_cleaned)) + 
  geom_boxplot()+ 
  ylab("CH4 flux umol/d/m2")+
  scale_y_continuous(limits = c(-1, 15000))+
  theme_light()+
  coord_polar() 
```

# average flux per species 
```{r}
# average fluxes 
ami <- mounds[mounds$ID_cleaned == 'Ami',]
avgflux_ami <- mean(ami$flux.CH4) # 3160 umol/m2*d
nasute <- mounds[mounds$ID_cleaned == 'Nasuti',]
avgflux_nasute <- mean(nasute$flux.CH4) # 4847 umol/m2*d
copto <- mounds[mounds$ID_cleaned == 'Copto',]
avgflux_copto <- mean(copto$flux.CH4) # 1752 umol/m2*d

# convert  umol/m2*d to ug/m2*d
avgflux_ami <- avgflux_ami*(1/1000000)*(16.04)*(1000000) # molecular mass conversion to g, then conversion back to ug for comparison 
avgflux_nasute <- avgflux_nasute*(1/1000000)*(16.04)*(1000000) 
avgflux_copto <- avgflux_copto*(1/1000000)*(16.04)*(1000000) 
# final units for average fluxes are now in ug CH4/m2*d
```

#### TODAY #####
# methane and co2 mound flux by temperature 
```{r}
# methane 
h1 <- ggplot(data = mounds, aes(x = avg_respT, y = flux.CH4, color = position)) + 
  geom_point(alpha=0.5)+ 
  ylab("CH4 flux umol/d/m2")+
  geom_smooth()+
  theme_light()

# co2
# first subset co2 df for only mound measures
moundsCO2 <- CO2_fluxfinal[CO2_fluxfinal$flux_source == 'm',]

h2 <- ggplot(data = moundsCO2, aes(x = avg_respT, y = flux.CO2, color = position)) + 
  geom_point(alpha=0.5)+ 
  ylab("CO2 flux mmol/d/m2")+
  geom_smooth()+
  theme_light()

h3 <- ggplot(data = mounds, aes(x = avg_respT, y = flux.CH4, color = ID_cleaned)) + 
  geom_point(alpha=0.5)+ 
  ylab("CH4 flux umol/d/m2")+
  geom_smooth()+
  theme_light()

h4 <- ggplot(data = moundsCO2, aes(x = avg_respT, y = flux.CO2, color = ID_cleaned)) + 
  geom_point(alpha=0.5)+ 
  ylab("CO2 flux mmol/d/m2")+
  geom_smooth()+
  theme_light()

ggarrange(h1, h2, h3, h4)
```

# methane vs. co2 regression 
```{r}
# new df with sample, ch4 and co2 
reg <- merge(CH4_fluxfinal, CO2_fluxfinal, by = c("Time_start")) 
reg <- reg[, c("Time_start", "flux.CH4", "flux.CO2", "flux.CO2_umol", "flux_source.x", "ID_cleaned.x", "avg_respT.x" )]
str(reg)
reg_mounds <- reg[reg$flux_source.x == 'm',]
reg_soils <- reg[reg$flux_source.x == 's',]

i1 <- ggplot(data = reg, aes(x = flux.CH4, y = flux.CO2_umol, color = ID_cleaned.x)) + 
  geom_point(alpha=0.5)+ 
  xlab("CH4 flux umol/d/m2")+
  ylab("CO2 flux umol/d/m2")+
  geom_smooth()+
  labs(title = "mound+soil")+
  theme_light()
i2 <- ggplot(data = reg_mounds, aes(x =log(flux.CO2_umol) , y =log(flux.CH4), color = ID_cleaned.x)) +
  geom_point(alpha=0.5)+ 
  ylab("CH4 flux umol/d/m2")+
  xlab("CO2 flux umol/d/m2")+
  geom_smooth()+
  labs(title = "mound")+
  theme_light()
i3 <- ggplot(data = reg_soils, aes(x = flux.CH4, y = flux.CO2_umol, color = ID_cleaned.x)) + 
  geom_point(alpha=0.5)+ 
  xlab("CH4 flux umol/d/m2")+
  ylab("CO2 flux umol/d/m2")+
  geom_smooth()+
  labs(title = "soil")+
  theme_light()
ggarrange(i1, i2, i3)
```




