---
title: "7.flux_viz"
author: "abbey yatsko"
date: "26/08/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(ggplot2)
library(dplyr)
library(plyr)
library(ggpubr)
library(patchwork)
```

data load 
```{r}
all_fluxes_NT <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_NT.csv")
p_fluxes_f <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/p_fluxes_f.csv")
all_fluxes_mound_avg <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_mound_avg.csv")
all_fluxes_mound <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_mound.csv")
all_fluxes_seasonal_avg <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_resample_reps_avg.csv")

# supplement (?)
all_fluxes_daily <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_daily_fluxes.csv")
```

Q1: How do termites differ in carbon gas flux? 
```{r}
# a) INDIVIDUAL TERMITES 
# TEF 
ggplot(all_fluxes_NT, aes(x = species, y = TEF_ug_g_h, fill = species))+
  geom_boxplot(outlier.shape = NA)+
  geom_jitter()+
  ylab("Termite EF (ug CH4/hr/g termite)")+
  xlab("")+
  scale_x_discrete(labels = c("A. laurensis", "C. acinaciformis", "N. magnus"))+
  scale_fill_brewer(palette = "Dark2")+
  theme_classic()+
  theme(legend.position = "none")

# PROPORTIONAL FLUXES
df <- p_fluxes_f[c("species", "prop_T_CH4", "prop_M_CH4", "prop_T_CO2", "prop_M_CO2")]
df_long <- df %>%
  pivot_longer(cols = starts_with("prop_"), 
               names_to = c(".value", "flux"), 
               names_pattern = "prop_(.*)_(.*)") %>%
  pivot_longer(cols = c(T, M), 
               names_to = "material", 
               values_to = "prop") 

ch4 <- ggplot(df_long[df_long$flux == "CH4",], aes(x = species, y = prop, fill = material))+
  geom_boxplot()+
  ylab("Proportion CH4 flux")+
  xlab("")+
  scale_x_discrete(labels = c("A. laurensis", "C. acinaciformis", "N. magnus"))+
  scale_fill_brewer(palette = "Dark2")+
  theme_classic()

co2 <- ggplot(df_long[df_long$flux == "CO2",], aes(x = species, y = prop, fill = material))+
  geom_boxplot()+
  ylab("Proportion CO2 flux")+
  xlab("")+
  scale_x_discrete(labels = c("A. laurensis", "C. acinaciformis", "N. magnus"))+
  scale_fill_brewer(palette = "Dark2")+
  theme_classic()

fig2 <- ch4 + co2 + plot_layout(guides = 'collect')

# test what the ratio of termite:mound mass is - best if consistent across the df (seems to be largely true)
p_fluxes_f$termite_mound_ratio <- p_fluxes_f$mass_termite_g / p_fluxes_f$mass_mound_material_g
ggplot(p_fluxes_f, aes(x = species, y = termite_mound_ratio, fill = species))+
  geom_boxplot()+
  ylab("Termite mass:Mound mass")+
  xlab("")+
  scale_x_discrete(labels = c("A. laurensis", "C. acinaciformis", "N. magnus"))+
  scale_fill_brewer(palette = "Dark2")+
  theme_classic()+
  theme(legend.position = "none")

# b) TERMITE MOUNDS 
ggplot(all_fluxes_mound_avg, aes(x = species_s, y = mean_mound_fluxCH4, fill = species_s)) + 
  geom_boxplot()+ 
  scale_x_discrete(labels = c("A. laurensis", "C. acinaciformis", "N. magnus"))+
  theme_classic()+
  ylab("CH4 flux umol/d/m2")+
  xlab("")+
  scale_fill_brewer(palette = "Dark2")+
  theme(legend.position = "none")

# test tests 
# a) one way anova 
aov1 <- aov(TEF_ug_g_h ~ species, data = all_fluxes_NT)
summary(aov1) # decent model, assumption checks are good 
TukeyHSD(aov1) # all species are significantly different 

# b) one way anova (unequal sample sizes)
aov2 <- aov(mean_mound_fluxCH4 ~ species_s, data = all_fluxes_mound_avg)
summary(aov2) # normality and HoV dont look great 

kruskal.test(mean_mound_fluxCH4 ~ species_s, data = all_fluxes_mound_avg)
dunn.test(all_fluxes_mound_avg$mean_mound_fluxCH4, all_fluxes_mound_avg$species_s, method = "bonferroni") # N. magnus different to laurensis, acinaciformis
```

Q2: How do mound properties influence CH4 flux? 
```{r}
# a) MOUND SIZE
# reorder levels of campaigns 
all_fluxes_mound_avg$campaign <- factor(all_fluxes_mound_avg$campaign, levels = c("may22", "aug23", "nov22", "feb24"))

# methane flux (whole mound) by mound size 
ggplot(all_fluxes_mound_avg, aes(x = SA_m2, y = mound_CH4flux, color = species_s)) + # swap out basal_area_m2, color = campaign
  geom_point()+ 
  geom_smooth(method = 'lm')+
  facet_wrap(~species_s, scales = "free")+ 
  scale_color_brewer(palette = "Dark2")+
  theme_classic()+
  ylab("Total mound CH4 flux (umol/d/mound)") +
  xlab("Mound surface area (m2)")+
  theme(legend.position = "none")

# average mound size by species
ggplot(all_fluxes_mound_avg, aes(x = species_s, y = SA_m2, fill = species_s))+ # swap out basal_area_m2
  geom_boxplot()+
  theme_classic()+
  xlab("")+
  ylab("Mound surface area (m2)")+
  scale_fill_brewer(palette = "Dark2")+
  theme(legend.position = "none")

# b) WALL THICKNESS
wt <- all_fluxes_mound[!is.na(all_fluxes_mound$wall_thickness_mm), ]
wt$sample <- as.factor(wt$sample)
# calculate average mound wall thickness
# wt_avg <- wt %>% group_by(ID_mound, sample, species_s) %>% 
#   summarise(mean_mound_fluxCH4=mean(flux.CH4),
#             mean_mound_fluxCO2=mean(flux.CO2_umol), 
#             mean_mound_fluxCH4_CO2=mean(CH4_CO2), 
#             campaign = campaign, 
#             temp = mean(avg_respT), 
#             precip_1mo = precip_1mo, 
#             wall_thickness_mm = mean(wall_thickness_mm))
# wt_mound_avg <- distinct(wt_avg)

ggplot(wt, aes(x = wall_thickness_mm, y = flux.CH4, color = species_s)) +
  geom_point()+ 
  geom_smooth(method = "lm")+
  facet_wrap(~species_s, scales = "free")+ 
  theme_classic()+
  ylab("CH4 flux umol/d/m2")+
  xlab("Mound wall thickness (mm)")+
  ggtitle("Average mound wall thickness")+
  scale_color_brewer(palette = "Dark2")+
  theme(legend.position = "bottom")

# test tests (run separate for each species)?
# a) lmer (random effects: sample, campaign/temp/precip_1mo)
species_list <- split(all_fluxes_mound_avg, all_fluxes_mound_avg$species_s)

run_model <- function(data) {
  lmer(log(mound_CH4flux) ~ SA_m2 + (1 | sample) + (1 | campaign), data = data)
}

models <- lapply(species_list, run_model)
lapply(models, Anova)

# b) lmer (random effects: sample)
# if log-transforming: need to adjust negative values (only 7 cases) to really small numbers (or eventually omit?)
# wt <- wt %>%
#   mutate(flux.CH4 = ifelse(flux.CH4 < 0, 0.00001, flux.CH4))

species_list2 <- split(wt, wt$species_s)

run_model2 <- function(data) {
  lmer(flux.CH4 ~ wall_thickness_mm + (1 | sample), data = data)
}

models <- lapply(species_list2, run_model2)
lapply(models, check_model)

```

Q3: How does the environment influence CH4 flux? 
```{r}
# a) seasonal comparison 
all_fluxes_seasonal_avg$campaign <- factor(all_fluxes_seasonal_avg$campaign, levels = c("may22", "aug23", "nov22", "feb24"))
all_fluxes_seasonal_avg$species_s <- as.factor(all_fluxes_seasonal_avg$species_s)

ggplot(all_fluxes_seasonal_avg, aes(x = species_s, y = mean_mound_fluxCH4, fill = campaign))+
  geom_boxplot()+
  ylab("CH4 flux umol/d/m2")+
  xlab("")+
  scale_fill_manual(values = c("may22" = "#1b9e77", "aug23" = "#d95f02", "nov22" =
                                 "#7570b3", "feb24" = "#e7298a"),
                    labels = c("Wet-to-dry", "Mid-dry", "Dry-to-wet", "Mid-wet")) +
  theme_classic()

# test tests
# a) lmer (sample as random factor)
mod <- lmer(mean_mound_fluxCH4 ~ species_s*campaign + (1 | sample), data = all_fluxes_seasonal_avg)
Anova(mod)
check_model(mod) # what to do about high colinearity? 
# posthoc pairwise comparisons
emmeans(mod, pairwise ~ species_s | campaign)
emmeans(mod, pairwise ~ campaign | species_s)

# b) environmental conditions (temperature and precipitation) 
ggplot(all_fluxes_seasonal_avg, aes(x = temp, y = mean_mound_fluxCH4, color = campaign))+
  geom_point()+
  facet_wrap(~species_s)+
  geom_smooth(method = 'lm', se = TRUE)+
  ylab("CH4 flux umol/d/m2")+
  xlab("Average Mound Surface Temperature (C)")+
  scale_color_brewer(palette = "Dark2")+
  theme_classic()

# model with temperature, species, and campaign
mod2 <- lmer(mean_mound_fluxCH4 ~ temp + species_s + campaign + (1 | sample), data = all_fluxes_seasonal_avg)
Anova(mod2)
check_model(mod2)
ggpredict(mod2, terms = c("temp", "campaign", "species_s")) %>% plot(add.data = TRUE)

# temperatures by campaign - this just shows seasonal variability
ggplot(all_fluxes_mound_avg, aes(x = campaign, y = temp, fill = campaign))+
  geom_boxplot()+
  geom_jitter()+
  ylab("Average Mound Surface Temperature (C)")+
  xlab("")+
  scale_fill_brewer(palette = "Dark2")+
  theme_classic()+
  theme(legend.position = "none")

aov <- aov(temp ~ campaign, data = all_fluxes_mound_avg)
summary(aov) # assumptions ok on check_model(aov) 
TukeyHSD(aov) # all comparisons are significantly different 













## WORKING EXTRAS ##

# temperature changes throughout the day
t <- all_fluxes_mound[all_fluxes_mound$campaign %in% c("nov22", "aug23", "feb24"),]
t$flux_start <- strptime(t$flux_start, "%H:%M")

tt <- all_fluxes_mound[all_fluxes_mound$campaign %in% c("may22"),]
start <- nchar(tt$flux_start) - 7
tt$flux_start_test <- substring(tt$flux_start, start, nchar(tt$flux_start))
tt$flux_start <- strptime(tt$flux_start_test, "%H:%M")
tt <- tt[, -which(names(tt) == "flux_start_test")]

all_fluxes_withtime <- rbind(t, tt)

# temperature throughout the day by season
ggplot(all_fluxes_withtime, aes(x = as.POSIXct(flux_start), y = avg_respT, color = campaign))+
  geom_jitter()+
  geom_smooth(method = 'loess', se = TRUE)+
  ylab("Average Mound Surface Temperature (C)")+
  xlab("Time of day")+
  theme_classic()

# table of averages by season (all mounds, not those with repeat measurements)
detach(package:plyr)
season_avg <- all_fluxes_mound_avg %>% group_by(species_s, campaign) %>% 
  summarize(mean_CH4flux = mean(mean_mound_fluxCH4), 
            mean_CO2flux = mean(mean_mound_fluxCO2), 
            sd_CH4flux = sd(mean_mound_fluxCH4), 
            sd_CO2flux = sd(mean_mound_fluxCO2), 
            count = n())
```

Q4: How do mound microbial communities influence carbon gas flux? 
```{r}

```

Q5: How do termite mound CH4 fluxes impact methane release at savanna landscape scales?
```{r}

```

Supplement
```{r}
# INTRAMOUND VARIATION OF MOUND FLUX
all_fluxes_mound$position <- ifelse(all_fluxes_mound$position == "top ", "top", all_fluxes_mound$position)
ggplot(data = all_fluxes_mound, aes(x = species_s, y = flux.CH4, fill = position)) + 
  geom_boxplot()+ 
  theme_classic()+
  ylab("CH4 flux umol/d/m2")+
  ylim(0,24000)+ # removes big outlier
  xlab("")

# direction on mound
ggplot(data = all_fluxes_mound, aes(x = directon, y = flux.CH4, fill = directon)) + 
  geom_boxplot()+ 
  theme_classic()+
  ylab("CH4 flux umol/d/m2")+
  ylim(0,24000)+ # removes big outlier
  xlab("Direction")+
  scale_x_discrete(limits = c("E", "N", "S", "W"), labels = c("E", "N", "S", "W"))

# TIME OF DAY AND FLUX
# reorder levels of time of day
all_fluxes_daily$time_of_day <- factor(all_fluxes_daily$time_of_day, levels = c("morning", "midday", "afternoon", "night"))

# time by flux for species
ggplot(all_fluxes_daily, aes(x = species_s, y = flux.CH4, fill = time_of_day))+
  geom_boxplot()+
  theme_classic()+
  xlab("")+
  ylab("CH4 flux (umol/d/mound)")+
  ylim(0,25000) # removes outlier

# calculate mound average for flux and temp 
all_fluxes_daily$sampleTOD <- paste(all_fluxes_daily$sample, all_fluxes_daily$time_of_day, sep = "-")
daily_avg <- all_fluxes_daily %>% group_by(sampleTOD) %>% 
  summarise(mean_mound_fluxCH4=mean(flux.CH4),
            mean_mound_fluxCO2=mean(flux.CO2_umol), 
            mean_mound_fluxCH4_CO2=mean(CH4_CO2), 
            time_of_day = time_of_day, 
            species_s = species_s,
            sample = sample,
            temp = mean(avg_respT))
daily_avg_f <- distinct(daily_avg)

# temp by flux for species at mound-level average
ggplot(daily_avg_f, aes(x = temp, y = mean_mound_fluxCH4, color = sample))+
  geom_point()+
  geom_smooth(method = "loess")+
  facet_wrap(~species_s, scales = "free_y")+
  theme_classic()+
  xlab("Temperature (C)")+
  ylab("CH4 flux (umol/d/mound)")
```


### DRAFT ###
species AVERAGE MOUND FLUX
```{r}
# table of averages by species
detach(package:plyr)
sp_avg <- all_fluxes_mound_avg %>% group_by(species_s) %>% 
  summarize(mean_CH4flux = mean(mean_mound_fluxCH4), 
            mean_CO2flux = mean(mean_mound_fluxCO2), 
            sd_CH4flux = sd(mean_mound_fluxCH4), 
            sd_CO2flux = sd(mean_mound_fluxCO2))
  
# unit conversion umol/m2*d to ug/m2*d (final units for CH4)
# flux*(1/1000000)*(16.04)*(1000000) 
# molecular mass conversion to g, then conversion back to ug for comparison 
```

mound flux and season
```{r}
# reorder levels of campaigns 
all_fluxes_mound_avg$campaign <- factor(all_fluxes_mound_avg$campaign, levels = c("may22", "aug23", "nov22", "feb24"))

# CH4 flux 
s1 <- ggplot(all_fluxes_mound_avg, aes(x = species_s, y = mean_mound_fluxCH4, fill = campaign)) + 
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylim(0, 22186) + # removes negative outlier
  ylab("CH4 flux umol/d/m2")+
  xlab("")+
  scale_fill_viridis_d(option = "plasma")+
  theme(legend.position = "none")

# CO2 flux 
s2 <- ggplot(data = all_fluxes_mound_avg, aes(x = species_s, y = mean_mound_fluxCO2, fill = campaign))+
  geom_boxplot()+ 
  scale_x_discrete(limits = c("N. magnus", "A. laurensis", "C. acinaciformis"))+  
  theme_classic()+
  ylab("CO2 flux mmol/d/m2")+
  xlab("")+
  scale_fill_viridis_d(option = "plasma")+
  theme(legend.position = "bottom")

s1 + s2 + plot_layout(ncol = 1)+ patchwork::plot_annotation(tag_levels = "a")
```
