---
title: "8.flux_models"
author: "abbey yatsko"
date: "2024-03-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

libraries
```{r}
library(ggplot2)
library(lme4)
library(car)
library(easystats)
library(ggeffects)
library(vegan)
library(partR2)
library(patchwork)
```

data load 
```{r}
all_fluxes_mound <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_mound.csv")
all_fluxes_resample_reps_avg <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_resample_reps_avg.csv")
all_fluxes_daily <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_daily_fluxes.csv")
```

Test 1: intramound variation
```{r}
all_fluxes_mound$tag <- as.factor(all_fluxes_mound$tag) 
all_fluxes_mound$position <- ifelse(all_fluxes_mound$position == "top ", "top", all_fluxes_mound$position)
all_fluxes_mound$position <- as.factor(all_fluxes_mound$position) 

# Fit linear mixed-effects model (which I think is best?)
mod1 <- lmer(flux.CH4 ~ tag + species_s + (1 | ID_mound), data = all_fluxes_mound)
Anova(mod1)
check_model(mod1)
ggpredict(mod1, terms = c("tag", "species_s")) %>% plot(add.data = TRUE)
# no significant effect of tag with random effect included
```

Mound-level CoV 
```{r}
# calculate CoV for each mound
detach(package:plyr)
cov <- all_fluxes_mound %>% group_by(ID_mound) %>% 
  summarize(mean = mean(flux.CH4), 
            sd = sd(flux.CH4),
            cov = sd(flux.CH4) / mean(flux.CH4))

# plot mean, sd, and cov
mean <- ggplot(cov, aes(mean)) +
  geom_histogram(aes(y=after_stat(density)), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme_classic()
sd <- ggplot(cov, aes(sd)) +
  geom_histogram(aes(y=after_stat(density)), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme_classic()
cov_p <- ggplot(cov, aes(cov)) +
  geom_histogram(aes(y=after_stat(density)), colour="black", fill="white")+
  geom_density(alpha=.2, fill="#FF6666") +
  theme_classic()
ggarrange(mean, sd, cov_p, ncol = 1)

# how many mounds have high COV values?
x <- cov[cov$cov > 1, ] # cov = 1 means that sd = mean 

# if intramound variation is not significant - calculate overall mound average and use this in further analyses
```

how species, season, temperature, and size effect mound flux (average rate per mound) for mounds that were remeasured in all 4 time points
```{r}
# Fit linear mixed-effects model
all_fluxes_resample_reps_avg$species_s <- as.factor(all_fluxes_resample_reps_avg$species_s)
all_fluxes_resample_reps_avg$campaign <- as.factor(all_fluxes_resample_reps_avg$campaign)
all_fluxes_resample_reps_avg$sample <- as.factor(all_fluxes_resample_reps_avg$sample)

# big model with them all in 
mod1 <- lmer(mean_mound_fluxCH4 ~ species_s + temp + precip_3mo  + SA_m2 + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod1)
check_model(mod1)
ggpredict(mod1, terms = c("temp", "species_s")) %>% plot(add.data = TRUE)

# same as above but swap basal area for surface area (different metric of size)
mod2 <- lmer(mean_mound_fluxCH4 ~ species_s + temp + precip_3mo  + basal_area_m2 + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod2)
check_model(mod2)

# remove SA from mod1
mod3 <- lmer(mean_mound_fluxCH4 ~ species_s + temp + precip_3mo + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod3)
check_model(mod3)

# same as above but drop precip from mod3
mod4 <- lmer(mean_mound_fluxCH4 ~ species_s + temp + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod4)
check_model(mod4)

# drop precip from mod 2 
mod5 <- lmer(mean_mound_fluxCH4 ~ species_s + temp  + basal_area_m2 + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod5)
check_model(mod5)
ggpredict(mod5, terms = c("temp", "basal_area_m2", "species_s")) %>% plot(add.data = TRUE)

# compare models
AIC(mod1, mod2, mod3, mod4, mod5)
```

how species, season, temperature, and size effect total mound flux for mounds that were remeasured in all 4 time points
```{r}
# define size factor as SA/BA 
all_fluxes_resample_reps_avg$size_factor <- all_fluxes_resample_reps_avg$SA_m2 / all_fluxes_resample_reps_avg$basal_area_m2

# Fit linear mixed-effects model with all factors 
mod6 <- lmer(mound_CH4flux ~ species_s + SA_m2 + temp + precip_3mo + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod6)
check_model(mod6)
ggpredict(mod6, terms = c("species_s", "SA_m2")) %>% plot(add.data = TRUE)

mod6int <- lmer(mound_CH4flux ~ species_s*SA_m2 + temp + precip_3mo + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod6int)

mod6int2x <- lmer(mound_CH4flux ~ species_s*SA_m2*temp + precip_3mo + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod6int2x)

# same as above but swap SA for the size factor
mod7 <- lmer(mound_CH4flux ~ species_s + size_factor + temp + precip_3mo + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod7)
check_model(mod7)

# remove precip from mod6int
mod8 <- lmer(mound_CH4flux ~ species_s*SA_m2 + temp + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod8)
check_model(mod8)

# remove temp from mod6
mod9 <- lmer(mound_CH4flux ~ species_s + SA_m2 + precip_3mo + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod9)
check_model(mod9)

# remove temp and precip from mod6int
mod10 <- lmer(mound_CH4flux ~ species_s + SA_m2 + (1 | sample) + (1|campaign), data = all_fluxes_resample_reps_avg)
Anova(mod10)
check_model(mod10)

# compare models
AIC(mod6, mod7, mod8, mod9, mod10)
```

variance partitioning from predictors of multiple regression models
see: https://cran.r-project.org/web/packages/partR2/vignettes/Using_partR2.html
and corresponding paper: https://peerj.com/articles/11414/
```{r}
# calculate marginal R2 (marginal = variance explained by fixed effects only. set R2_type to "conditional" for fixed+random)
R2_mod5_m <- partR2(mod5, data = all_fluxes_resample_reps_avg, R2_type = "marginal", nboot = 10)
R2_mod5_c <- partR2(mod5, data = all_fluxes_resample_reps_avg, R2_type = "conditional", nboot = 10)

# how much do predictors explain: uniquely and together
a <- partR2(mod5, partvars = c("temp", "basal_area_m2", "species_s"), 
                  R2_type = "marginal", nboot = 10)
summary(a)

# visualization 
p1 <- forestplot(a, type = "R2", text_size = 10)
p2 <- forestplot(a, type = "IR2", text_size = 10)
p3 <- forestplot(a, type = "SC", text_size = 10)
p4 <- forestplot(a, type = "BW", text_size = 10)
(p1 + p2) / (p3 + p4) + plot_annotation(tag_levels = "A")

### DARFT ###

# from mod5 (best model atm)
vp <- varpart(all_fluxes_resample_reps_avg$mean_mound_fluxCH4, ~ temp, ~ species_s, ~ basal_area_m2, data = all_fluxes_resample_reps_avg)
plot(vp, Xnames = c("Temp", "Species", "Basal area"), bg = c("seagreen3", "mediumpurple", "yellow"), alpha = 80, 
     digits = 2, cex = 1.5)

# test for significance of three influential factors using RDA
rda <- rda(all_fluxes_resample_reps_avg$mean_mound_fluxCH4 ~ temp + species_s + basal_area_m2, data = all_fluxes_resample_reps_avg)
rda

```

does mound flux change throughout the day, temperature response/Q10 
```{r}
# first test the effect of intramound variation to see if values can be averaged
all_fluxes_daily$tag <- as.factor(all_fluxes_daily$tag)
all_fluxes_daily$species_s <- as.factor(all_fluxes_daily$species_s)

mod7 <- lmer(flux.CH4 ~ tag + species_s + (1 | sample), data = all_fluxes_daily)
anova(mod7)
check_model(mod7)
ggpredict(mod7, terms = c("tag", "species_s")) %>% plot(add.data = TRUE)
# doesn't matter - generate mound-level averages and then test the effect of time of day 

# generate mound level averages for daily measurement df
all_fluxes_daily$ID_mound <- paste(all_fluxes_daily$sample, all_fluxes_daily$time_of_day, sep = "-")

all_fluxes_daily_avg <- all_fluxes_daily %>% group_by(ID_mound, sample, species_s) %>% 
  summarise(mean_mound_fluxCH4=mean(flux.CH4),
            mean_mound_fluxCO2=mean(flux.CO2_umol), 
            mean_mound_fluxCH4_CO2=mean(CH4_CO2), 
            time_of_day = time_of_day, 
            temp = mean(avg_respT))
all_fluxes_daily_avg <- distinct(all_fluxes_daily_avg)

# model 
mod8 <- lmer(mean_mound_fluxCH4 ~ species_s + time_of_day + temp + (1 | sample), data = all_fluxes_daily_avg)
anova(mod8)
check_model(mod8)
ggpredict(mod8, terms = c( "time_of_day", "temp", "species_s")) %>% plot(add.data = TRUE)

# high collinearity between time of day and temperature - maybe include interaction? 
```

mound flux and wall thickness 
```{r}
df <- all_fluxes_mound[!is.na(all_fluxes_mound$wall_thickness_mm), ]
mod <- lm(flux.CH4 ~ wall_thickness_mm, data = df)
summary(mod)
check_model(mod)
ggpredict(mod, terms = c("wall_thickness_mm")) %>% plot(add.data = TRUE)
```

