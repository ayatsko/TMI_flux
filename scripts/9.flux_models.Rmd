---
title: "8.flux_models"
author: "abbey yatsko"
date: "2024-03-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

libraries
```{r}
library(ggplot2)
library(lme4)
library(car)
library(easystats)
library(ggeffects)
library(vegan)
library(partR2)
library(patchwork)
```

data load 
```{r}
p_fluxes_f <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/p_fluxes_f.csv")
all_fluxes_mound_avg <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_mound_avg.csv")
all_fluxes_mound <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_mound.csv")






all_fluxes_resample_reps_avg <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_fluxes_resample_reps_avg.csv")

all_fluxes_daily <- read.csv("/Users/abbeyyatsko/Desktop/repos/TMI_flux/data/finalfluxes/all_daily_fluxes.csv")

```

Termite fluxes with/without the context of their environment
```{r}
# Q1: How does TEF vary across study species (fluxes from individuals)
# test for differences between species 
mod <- aov(TEF_ug_g_h ~ species, data = p_fluxes_f)
summary(mod)
# determine which species are different
emmeans(mod, pairwise ~ species)

# Q2: How do mound fluxes vary across study species (mean fluxes from the mound)
mod <- aov(mean_mound_fluxCH4 ~ species_s, data = all_fluxes_mound_avg)
summary(mod)
emmeans(mod, pairwise ~ species_s)

# Q3: What are the fluxes associated with termites in the mound vs. termites outside mound

```

How do mound traits contribute to CH4 flux? 
```{r}
# Q1: What is the relationship between mound wall thickness and CH4 flux? 
# flux influenced by wall thickness
wt <- all_fluxes_mound[!is.na(all_fluxes_mound$wall_thickness_mm), ]
wt$sample <- as.factor(wt$sample)

mod <-  lmer(flux.CH4 ~ wall_thickness_mm + (1 | species_s) + (1 | sample), data = wt)
summary(mod)
Anova(mod)
ggpredict(mod, terms = c("wall_thickness_mm")) %>% plot(add.data = TRUE)

# look at relationship just for coptotermes
mod <-  lmer(flux.CH4 ~ wall_thickness_mm + (1 | sample), data = wt[wt$species_s == "C. acinaciformis",])
Anova(mod)

# average wall thickness by species
mod <- aov(wall_thickness_mm ~ species_s, data = wt)
summary(mod)
emmeans(mod, pairwise ~ species_s)

# Q2: What is the relationship between mound size and CH4 flux? 
# whole mound methane flux mound size (basal_area_m2, sa_m2_final, volume_m3_final)
mod <- lmer(mound_CH4flux ~ volume_m3_final + (1 | species_s) + (1 | sample), data = all_fluxes_mound_avg)
summary(mod)
Anova(mod)
ggpredict(mod, terms = c("volume_m3_final")) %>% plot(add.data = TRUE)

mod_ami <- lmer(mound_CH4flux ~ volume_m3_final + (1 | sample), data = all_fluxes_mound_avg[all_fluxes_mound_avg$species_s =="A. laurensis",])
mod_cop <- lmer(mound_CH4flux ~ volume_m3_final + (1 | sample), data = all_fluxes_mound_avg[all_fluxes_mound_avg$species_s =="C. acinaciformis",])
mod_nas <- lmer(mound_CH4flux ~ volume_m3_final + (1 | sample), data = all_fluxes_mound_avg[all_fluxes_mound_avg$species_s =="N. magnus",])
summary(mod_nas)

# average mound size by species
mod <- aov(volume_m3_final ~ species_s, data = all_fluxes_mound_avg)
summary(mod)
emmeans(mod, pairwise ~ species_s)

# Q3: What is the relationship between mound volume, termite biomass, and CH4 flux? 

```

How do seasons and temperature effect CH4 flux?
```{r}
# Q1: How does CH4 flux change by season?
mod <- lmer(mean_mound_fluxCH4 ~ campaign + (1 | species_s) + (1 | sample), data = all_fluxes_seasonal_avg)
summary(mod)
emm <- emmeans(mod, ~ campaign)
pairs(emm)

# Q2: How does CH4 flux change by temperature?
# LINEAR
mod <- lmer(mean_mound_fluxCH4 ~ temp + campaign + (1 | sample) + (1 | species_s), data = all_fluxes_seasonal_avg)
Anova(mod)

# POLYNOMIAL 
mod_poly <- lmer(mean_mound_fluxCH4 ~ poly(temp, 2) + campaign + (1 | sample) + (1 | species_s), data = all_fluxes_seasonal_avg)
Anova(mod_poly)
emmeans(mod_poly, pairwise ~ campaign)


residuals <- resid(mod_poly)
fitted_values <- fitted(mod_poly)
```

