---
title: "8.flux_models"
author: "abbey yatsko"
date: "2024-03-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

libraries
```{r}

```

data load 
```{r}

```


TESTS YAY 

Intramound variation - look at mound-level CoV 
```{r}
# calculate CoV for each mound
detach(package:plyr)
cov <- all_fluxes_resample %>% group_by(ID_mound) %>% 
  summarize(cov = sd(flux.CH4) / mean(flux.CH4))
ggplot(cov, aes(cov)) +
  geom_histogram(aes(y=after_stat(density)), colour="black", fill="white")+
 geom_density(alpha=.2, fill="#FF6666") +
  theme_classic()

x <- cov[cov$cov > 1, ] # 14/75 mounds have high CoV - test these further
names <- x$ID_mound
test <- all_fluxes_resample[all_fluxes_resample$ID_mound %in% names,]

# one-way anova - using measurement tags (4-5 per mound)
ggboxplot(test, x = "tag", y = "flux.CH4",
          color = "tag", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#FC4E40", "#FC9E40"),
          ylab = "Flux", xlab = "Position")
aov1 <- aov(flux.CH4 ~ tag, data = test)
summary(aov1)

# one-way anova - using position (Mid/low/top)
ggboxplot(test, x = "position", y = "flux.CH4",
          color = "position", palette = c("#00AFBB", "#E7B800", "#FC4E07"),
          ylab = "Flux", xlab = "Position")
aov2 <- aov(flux.CH4 ~ position, data = test)
summary(aov2)

# one-way anova - using direction (NESW)
ggboxplot(test, x = "directon", y = "flux.CH4",
          color = "directon", palette = c("#00AFBB", "#E7B800", "#FC4E07", "#FC4E40", "#FC9E40"),
          ylab = "Flux", xlab = "Position")
aov3 <- aov(flux.CH4 ~ directon, data = test)
summary(aov3)

# intramound variation is not significant - calculate overall mound average and use this in further analyses
```

Testing models randomly and with some difficulty
```{r}
# model with subsample position within individual mound measurement as a random effect
# CH4
model <- lmer(flux.CH4 ~ species_s + campaign + avg_respT + (1|tag), data=all_fluxes_resample, REML=TRUE)
anova(model)
rand(model)
check_model(model)
ggpredict(model, terms = c("avg_respT", "species_s", "campaign")) %>% plot(add.data = TRUE)

# CO2
model <- lmer(flux.CO2 ~ species_s + campaign + avg_respT + (1|tag), data=all_fluxes_resample, REML=TRUE)
anova(model)
rand(model)
check_model(model)
ggpredict(model, terms = c("avg_respT", "species_s", "campaign")) %>% plot(add.data = TRUE)

```

Variance partitioning 
```{r}
# what variables may matter: species, campaign, temperature, intramound position, hour of measurement, individual mound?
# restructure factor variables
all_fluxes_resample$species_s <- as.factor(all_fluxes_resample$species_s) 
all_fluxes_resample$campaign <- as.factor(all_fluxes_resample$campaign)
all_fluxes_resample$tag <- as.factor(all_fluxes_resample$tag)
all_fluxes_resample$sample <- as.factor(all_fluxes_resample$sample)

# extract hour of measurement from flux_start column 
h <- all_fluxes_resample$flux_start
i <- sub("\\:.*", "", h)
j <- i[121:344]
k <- i[1:120]
l <- str_sub(k, -2)
hours <- c(l,j)
all_fluxes_resample$hour <- hours
all_fluxes_resample <- all_fluxes_resample %>% relocate(hour, .after = flux_start)
all_fluxes_resample$hour <- as.numeric(all_fluxes_resample$hour)

# reasonable model, main variables of interest
vp <- varpart(all_fluxes_resample$flux.CH4, ~ avg_respT, ~ campaign, ~ species_s, data = all_fluxes_resample)
plot(vp, Xnames = c("Temp", "Campaign", "Species"), bg = c("seagreen3", "mediumpurple", "yellow"), alpha = 80, 
     digits = 2, cex = 1.5)

# model hierarchy (kelsey paper) 
# for within mound (sub measurements, temp?, position) - how much does it matter for intramound measures?
# within species (sample, temp?)
# between species (temp, campaign, time of day)

# random testing 
vp <- varpart(all_fluxes_resample$flux.CH4, ~ species_s, ~ avg_respT, ~ hour, data = all_fluxes_resample)
plot(vp, Xnames = c("Species", "Campaign", "Flux start"), bg = c("seagreen3", "mediumpurple", "yellow"), alpha = 80, 
     digits = 2, cex = 1.5)

# what parts of the partitioning are significant?
# test for significance of three influential factors using RDA
rda <- rda(all_fluxes_resample$flux.CH4~avg_respT+campaign+species_s, data=all_fluxes_resample)
rda
step.forward <- ordistep(rda(all_fluxes_resample$flux.CH4 ~ 1, data=all_fluxes_resample), scope=formula (rda), direction="forward", pstep=1000)

# temporal factors / environmental factors run seperately? 

# new package: POV
library("POV")

# level 1: within mound variation - does position matter? 
POV(flux.CH4 ~ ID_mound, Data = all_fluxes_resample, Complete=TRUE)
# Within ID_mound > Between ID_mound means that mound subsamples do matter? 

POV(flux.CH4 ~ ID_mound*position, Data = all_fluxes_resample, Complete=TRUE)
# variation across mounds is more important than the variation within mounds? 

# level 2: within species variation - does individual matter? 
POV(flux.CH4 ~ species_s*ID_mound, Data = all_fluxes_resample, Complete=TRUE)

# level 3: across species variation - do other environmental/time factors matter?
POV(flux.CH4 ~ campaign*ID_mound, Data = all_fluxes_resample, Complete=TRUE)

```
